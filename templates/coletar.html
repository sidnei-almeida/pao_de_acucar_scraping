{% extends "base.html" %}

{% block title %}Coletar Dados - API de Dados Nutricionais{% endblock %}

{% block content %}
<div class="container">
    <h1>Coletar Dados</h1>
    <p>Configure e inicie uma nova coleta de dados nutricionais</p>

    <form id="coleta-form" method="POST">
        <div class="select-container">
            <label class="select-label">Modo de Coleta</label>
            <select name="modo">
                <option value="teste">Modo Teste - Coleta limitada para testes</option>
                <option value="ilimitado">Modo Ilimitado - Coleta sem limites</option>
            </select>
        </div>

        <div class="select-container" id="categoriasGroup">
            <label class="select-label">Selecione as Categorias</label>
            <select name="categorias" multiple>
                <option value="1">Açougue</option>
                <option value="2">Alimentos Congelados</option>
                <option value="3">Alimentos Refrigerados</option>
                <option value="4">Básicos da Despensa</option>
                <option value="5">Cereais</option>
                <option value="6">Complemento da Despensa</option>
                <option value="7">Doces e Sobremesas</option>
                <option value="8">Hortifruti</option>
                <option value="9">Mercearia Salgada</option>
                <option value="10">Padaria</option>
                <option value="11">Peixaria</option>
                <option value="12">Rotisserie</option>
                <option value="13">Salgadinhos e Aperitivos</option>
            </select>
            <span class="select-help">Pressione CTRL para selecionar múltiplas categorias</span>
        </div>

        <div class="button-group">
            <button type="submit" id="iniciar-btn" class="btn btn--primary">
                <i class="fas fa-play"></i>
                Iniciar Coleta
            </button>
            <button type="button" id="cancelar-btn" class="btn btn--danger" style="display: none;">
                <i class="fas fa-stop"></i>
                Cancelar Coleta
            </button>
        </div>
    </form>

    <div id="log-container" class="log-container" style="display: none;">
        <h2>Log de Atividades</h2>
        <div id="log-content" class="log-content"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io({
        reconnection: true,
        reconnectionAttempts: Infinity,  // Tenta reconectar indefinidamente
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        timeout: 20000
    });
    
    const logContent = document.getElementById('log-content');
    const form = document.getElementById('coleta-form');
    const categoriasSelect = document.querySelector('select[name="categorias"]');
    const logContainer = document.getElementById('log-container');
    const iniciarBtn = document.getElementById('iniciar-btn');
    const cancelarBtn = document.getElementById('cancelar-btn');
    let coletaEmAndamento = false;
    let ultimaMensagem = '';
    let tentativasReconexao = 0;

    // Conexão Socket.IO
    socket.on('connect', () => {
        console.log('Conectado ao servidor');
        adicionarLogSistema('Conectado ao servidor', 'success');
        tentativasReconexao = 0;
    });

    socket.on('disconnect', () => {
        console.log('Desconectado do servidor');
        adicionarLogSistema('Desconectado do servidor. Tentando reconectar...', 'warning');
    });

    socket.on('reconnect', (attemptNumber) => {
        console.log('Reconectado ao servidor');
        adicionarLogSistema('Reconectado ao servidor', 'success');
        tentativasReconexao = 0;
    });

    socket.on('reconnect_error', (error) => {
        console.error('Erro ao reconectar:', error);
        tentativasReconexao++;
        adicionarLogSistema(`Erro ao reconectar ao servidor (tentativa ${tentativasReconexao})`, 'error');
    });

    socket.on('reconnect_attempt', () => {
        adicionarLogSistema('Tentando reconectar ao servidor...', 'info');
    });

    // Função para adicionar logs do sistema
    function adicionarLogSistema(mensagem, tipo) {
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry system ${tipo}`;
        const timestamp = new Date().toLocaleTimeString();
        logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> Sistema: ${mensagem}`;
        logContent.appendChild(logEntry);
        logContent.scrollTop = logContent.scrollHeight;
    }

    // Atualização do log em tempo real
    socket.on('log_update', function(data) {
        // Evita mensagens duplicadas
        if (data.message === ultimaMensagem) {
            return;
        }
        ultimaMensagem = data.message;

        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${data.type}`;
        
        const timestamp = new Date().toLocaleTimeString();
        logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${data.message}`;
        
        logContent.appendChild(logEntry);
        logContent.scrollTop = logContent.scrollHeight;

        // Se receber mensagem de conclusão ou cancelamento, finaliza a coleta
        if (data.message.includes('Coleta finalizada com sucesso') ||
            data.message.includes('Sistema pronto para nova coleta')) {
            finalizarColeta();
            // Adiciona mensagem de sucesso
            const successEntry = document.createElement('div');
            successEntry.className = 'log-entry success';
            successEntry.innerHTML = `<span class="timestamp">[${new Date().toLocaleTimeString()}]</span> ✅ Todos os dados foram coletados com sucesso!`;
            logContent.appendChild(successEntry);
            logContent.scrollTop = logContent.scrollHeight;
        } else if (data.message.includes('Coleta cancelada')) {
            finalizarColeta();
        }
    });

    // Função para iniciar a coleta
    function iniciarColeta() {
        coletaEmAndamento = true;
        iniciarBtn.style.display = 'none';
        cancelarBtn.style.display = 'inline-block';
        categoriasSelect.disabled = true;
        logContainer.style.display = 'block';
        logContent.innerHTML = ''; // Limpa logs anteriores
        ultimaMensagem = ''; // Reseta o controle de mensagens duplicadas
    }

    // Função para finalizar a coleta
    function finalizarColeta() {
        coletaEmAndamento = false;
        iniciarBtn.style.display = 'inline-block';
        cancelarBtn.style.display = 'none';
        categoriasSelect.disabled = false;
    }

    // Validação e envio do formulário
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const selectedCategories = Array.from(categoriasSelect.selectedOptions);
        if (selectedCategories.length === 0) {
            alert('Por favor, selecione pelo menos uma categoria.');
            return;
        }

        // Primeiro inicia a coleta (UI)
        iniciarColeta();

        try {
            // Cria um FormData com os dados do formulário
            const formData = new FormData();
            formData.append('modo', form.querySelector('select[name="modo"]').value);
            
            // Adiciona cada categoria selecionada
            selectedCategories.forEach(option => {
                formData.append('categorias', option.value);
            });

            const response = await fetch('/coletar', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.detail || 'Erro ao iniciar coleta');
            }

        } catch (error) {
            console.error('Erro:', error);
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry error';
            logEntry.innerHTML = `<span class="timestamp">[${new Date().toLocaleTimeString()}]</span> Erro: ${error.message}`;
            logContent.appendChild(logEntry);
            finalizarColeta();
        }
    });

    // Cancelamento da coleta
    cancelarBtn.addEventListener('click', async function() {
        if (coletaEmAndamento) {
            try {
                // Desabilita o botão durante o cancelamento
                cancelarBtn.disabled = true;
                cancelarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cancelando...';

                const response = await fetch('/cancelar-coleta', {
                    method: 'POST'
                });

                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.detail || 'Erro ao cancelar coleta');
                }

                // Aguarda a resposta do servidor
                const result = await response.json();
                console.log('Coleta cancelada:', result);

                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry warning';
                logEntry.innerHTML = `<span class="timestamp">[${new Date().toLocaleTimeString()}]</span> Cancelando coleta...`;
                logContent.appendChild(logEntry);

            } catch (error) {
                console.error('Erro ao cancelar:', error);
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry error';
                logEntry.innerHTML = `<span class="timestamp">[${new Date().toLocaleTimeString()}]</span> Erro ao cancelar: ${error.message}`;
                logContent.appendChild(logEntry);
            } finally {
                // Reabilita o botão
                cancelarBtn.disabled = false;
                cancelarBtn.innerHTML = '<i class="fas fa-stop"></i> Cancelar Coleta';
            }
        }
    });
});
</script>

<style>
.button-group {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.btn--danger {
    background-color: #dc3545;
    color: white;
}

.btn--danger:hover {
    background-color: #c82333;
}

.log-entry {
    padding: 8px;
    margin: 4px 0;
    border-radius: 4px;
    font-family: monospace;
}

.success {
    color: #98c379;
    background-color: rgba(152, 195, 121, 0.1);
    border: 1px solid rgba(152, 195, 121, 0.3);
}

.info {
    color: #61afef;
    background-color: rgba(97, 175, 239, 0.1);
    border: 1px solid rgba(97, 175, 239, 0.3);
}

.warning {
    color: #e5c07b;
    background-color: rgba(229, 192, 123, 0.1);
    border: 1px solid rgba(229, 192, 123, 0.3);
}

.error {
    color: #e06c75;
    background-color: rgba(224, 108, 117, 0.1);
    border: 1px solid rgba(224, 108, 117, 0.3);
}

.system {
    font-style: italic;
    opacity: 0.9;
    border-left: 3px solid #abb2bf;
    margin-left: -0.5rem;
    padding-left: 0.5rem;
}

.timestamp {
    color: #abb2bf;
    font-size: 0.9em;
    margin-right: 0.5rem;
    opacity: 0.8;
}

#log-container {
    border: 1px solid #3e4451;
    border-radius: 6px;
    padding: 1rem;
    margin-top: 1rem;
    max-height: 400px;
    overflow-y: auto;
}

#log-content {
    font-family: 'Consolas', 'Monaco', monospace;
}
</style>
{% endblock %} 