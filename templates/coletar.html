{% extends "base.html" %}

{% block title %}Coletar Dados - API de Dados Nutricionais{% endblock %}

{% block content %}
<div class="container">
    <h1>Coletar Dados</h1>
    <p>Configure e inicie uma nova coleta de dados nutricionais</p>

    <form id="coleta-form" method="POST">
        <div class="select-container">
            <label class="select-label">Modo de Coleta</label>
            <select name="modo">
                <option value="teste">Modo Teste - Coleta limitada para testes</option>
                <option value="ilimitado">Modo Ilimitado - Coleta sem limites</option>
            </select>
        </div>

        <div class="select-container" id="categoriasGroup">
            <label class="select-label">Selecione as Categorias</label>
            <select name="categorias" multiple>
                <option value="1">Açougue</option>
                <option value="2">Alimentos Congelados</option>
                <option value="3">Alimentos Refrigerados</option>
                <option value="4">Básicos da Despensa</option>
                <option value="5">Cereais</option>
                <option value="6">Complemento da Despensa</option>
                <option value="7">Doces e Sobremesas</option>
                <option value="8">Hortifruti</option>
                <option value="9">Mercearia Salgada</option>
                <option value="10">Padaria</option>
                <option value="11">Peixaria</option>
                <option value="12">Rotisserie</option>
                <option value="13">Salgadinhos e Aperitivos</option>
            </select>
            <span class="select-help">Pressione CTRL para selecionar múltiplas categorias</span>
        </div>

        <button type="submit" class="btn btn--primary">
            <i class="fas fa-play"></i>
            Iniciar Coleta
        </button>
    </form>

    <div id="log-container" class="log-container" style="display: none;">
        <h2>Log de Atividades</h2>
        <div id="log-content" class="log-content"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const logContent = document.getElementById('log-content');
    const form = document.getElementById('coleta-form');
    const categoriasSelect = document.querySelector('select[name="categorias"]');
    const logContainer = document.getElementById('log-container');

    // Conexão Socket.IO
    socket.on('connect', () => {
        console.log('Conectado ao servidor');
    });

    socket.on('disconnect', () => {
        console.log('Desconectado do servidor');
    });

    // Atualização do log em tempo real
    socket.on('log_update', function(data) {
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${data.type}`;
        
        const timestamp = new Date().toLocaleTimeString();
        logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${data.message}`;
        
        logContent.appendChild(logEntry);
        logContent.scrollTop = logContent.scrollHeight;
    });

    // Validação e envio do formulário
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const selectedCategories = Array.from(categoriasSelect.selectedOptions);
        if (selectedCategories.length === 0) {
            alert('Por favor, selecione pelo menos uma categoria.');
            return;
        }

        // Mostra o container de log
        logContainer.style.display = 'block';
        logContent.innerHTML = ''; // Limpa logs anteriores

        try {
            const response = await fetch('/coletar', {
                method: 'POST',
                body: new FormData(form)
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.detail || 'Erro ao iniciar coleta');
            }

        } catch (error) {
            console.error('Erro:', error);
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry error';
            logEntry.innerHTML = `<span class="timestamp">[${new Date().toLocaleTimeString()}]</span> Erro: ${error.message}`;
            logContent.appendChild(logEntry);
        }
    });
});
</script>
{% endblock %} 